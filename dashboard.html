<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Administraci√≥n - Supermercados Comodin</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="./img/favicon.png" sizes="32x32">
    <link rel="shortcut icon" href="./img/favicon.png" type="image/png">
    <link rel="apple-touch-icon" href="./img/favicon.png">

    <!-- EXO 2 (T√≠tulos) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>

<style>
    :root {
        --c-black: #000000;
        --c-ink: #1a181d;
        --c-white: #fefeff;
        --c-pink: #e17bd7;
        --c-cyan: #6be1e3;
        --c-gold: #e4c76a;
        --c-slate: #a4a8c0;
        --c-mist: #c6c9d7;

        --font-title: "Exo 2", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        --font-sub: "Futura", "Futura PT", "Avenir", "Trebuchet MS", "Segoe UI", Arial, sans-serif;

        --radius-md: 12px;
        --radius-lg: 18px;
        --shadow-soft: 0 18px 60px rgba(0, 0, 0, .55);
        --stroke: rgba(198, 201, 215, .25);
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0
    }

    html {
        scroll-behavior: smooth
    }

    body {
        background: radial-gradient(1200px 700px at 70% 25%, rgba(225, 123, 215, .18), transparent 55%),
            radial-gradient(1100px 700px at 80% 60%, rgba(107, 225, 227, .14), transparent 55%),
            radial-gradient(900px 600px at 20% 70%, rgba(228, 199, 106, .10), transparent 60%),
            linear-gradient(180deg, var(--c-black), var(--c-ink));
        color: var(--c-white);
        font-family: var(--font-sub);
        line-height: 1.5;
        min-height: 100vh;
        overflow-x: hidden;
    }

    .bg {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: -2;
    }

    .bg::before {
        content: "";
        position: absolute;
        inset: -10%;
        background:
            radial-gradient(circle at 25% 20%, rgba(107, 225, 227, .12), transparent 40%),
            radial-gradient(circle at 80% 35%, rgba(225, 123, 215, .12), transparent 38%),
            radial-gradient(circle at 55% 85%, rgba(228, 199, 106, .10), transparent 45%);
        filter: blur(18px);
        opacity: .95;
        transform: translateZ(0);
    }

    .hex {
        position: absolute;
        inset: -20%;
        opacity: .16;
        filter: drop-shadow(0 0 12px rgba(107, 225, 227, .15));
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='260' height='150' viewBox='0 0 260 150'%3E%3Cg fill='none' stroke='%23c6c9d7' stroke-opacity='0.85' stroke-width='1'%3E%3Cpath d='M50 20l20-12 20 12v24l-20 12-20-12z'/%3E%3Cpath d='M120 20l20-12 20 12v24l-20 12-20-12z'/%3E%3Cpath d='M190 20l20-12 20 12v24l-20 12-20-12z'/%3E%3Cpath d='M85 55l20-12 20 12v24l-20 12-20-12z'/%3E%3Cpath d='M155 55l20-12 20 12v24l-20 12-20-12z'/%3E%3Cpath d='M50 90l20-12 20 12v24l-20 12-20-12z'/%3E%3Cpath d='M120 90l20-12 20 12v24l-20 12-20-12z'/%3E%3Cpath d='M190 90l20-12 20 12v24l-20 12-20-12z'/%3E%3C/g%3E%3C/svg%3E");
        background-size: 260px 150px;
        background-repeat: repeat;
        transform: rotate(-8deg);
        mix-blend-mode: screen;
    }

    canvas#stars {
        position: absolute;
        inset: 0;
        opacity: 1;
    }

    .hidden {
        display: none !important;
    }

    /* LOGIN VIEW */
    #admin-login-view {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 2rem;
    }

    .login-card {
        background:
            radial-gradient(900px 600px at 70% 35%, rgba(225, 123, 215, .18), transparent 55%),
            radial-gradient(900px 600px at 45% 60%, rgba(107, 225, 227, .16), transparent 60%),
            linear-gradient(180deg, rgba(254, 254, 255, .07), rgba(26, 24, 29, .72));
        border-radius: var(--radius-lg);
        padding: 2.5rem 2rem;
        box-shadow: var(--shadow-soft);
        border: 1px solid rgba(198, 201, 215, .18);
        width: 100%;
        max-width: 460px;
        backdrop-filter: blur(16px);
    }

    .login-title {
        font-family: var(--font-title);
        font-size: 1.9rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        text-align: center;
        letter-spacing: -.01em;
        text-shadow: 0 10px 40px rgba(0, 0, 0, .55);
    }

    .login-subtitle {
        font-size: 0.9rem;
        color: rgba(198, 201, 215, .88);
        margin-bottom: 2rem;
        text-align: center;
    }

    @keyframes logoPulse {

        0%,
        100% {
            box-shadow: 0 0 0 1px rgba(198, 201, 215, .18), 0 0 40px rgba(107, 225, 227, .18);
            transform: scale(1);
        }

        50% {
            box-shadow: 0 0 0 1px rgba(198, 201, 215, .22), 0 0 55px rgba(225, 123, 215, .22);
            transform: scale(1.03);
        }
    }

    .login-logo {
        width: 80px;
        height: 80px;
        border-radius: 999px;
        background-image: url('./img/comodin.png');
        background-size: cover;
        background-position: center;
        box-shadow: 0 0 0 1px rgba(198, 201, 215, .18), 0 0 40px rgba(107, 225, 227, .18);
        animation: logoPulse 4.5s ease-in-out infinite;
        margin: 0 auto 1.5rem;
        position: relative;
        overflow: hidden;
    }

    .login-logo::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 30% 30%, rgba(254, 254, 255, .14), transparent 55%);
        pointer-events: none;
    }

    /* Inputs */
    .field-group {
        margin-bottom: 1.5rem;
    }

    .field-group label {
        display: block;
        font-size: 0.9rem;
        font-weight: 600;
        color: rgba(198, 201, 215, .88);
        margin-bottom: .5rem;
    }

    .field-group input[type="text"],
    .field-group input[type="password"],
    .field-group select {
        width: 100%;
        padding: 0.9rem 1rem;
        font-size: 0.95rem;
        background: rgba(254, 254, 255, .06);
        border: 1px solid rgba(198, 201, 215, .22);
        border-radius: var(--radius-md);
        color: var(--c-white);
        transition: border-color .2s ease, background .2s ease, box-shadow .2s ease;
        outline: none;
        backdrop-filter: blur(12px);
    }

    .field-group input:focus,
    .field-group select:focus {
        border-color: rgba(107, 225, 227, .55);
        box-shadow: 0 0 0 3px rgba(107, 225, 227, .14);
        background: rgba(254, 254, 255, .075);
    }

    .field-group select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg fill='white' height='12' width='12' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 12px;
    }

    .field-group select option {
        background-color: #151318;
        color: var(--c-white);
    }

    /* Buttons */
    .btn {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: .5rem;
        padding: .85rem 1.5rem;
        font-size: .95rem;
        border-radius: 999px;
        border: 1px solid rgba(198, 201, 215, .22);
        cursor: pointer;
        transition: transform .15s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease;
        white-space: nowrap;
        font-weight: 700;
        font-family: var(--font-sub);
        color: var(--c-white);
        background: rgba(254, 254, 255, .06);
        box-shadow: 0 10px 40px rgba(0, 0, 0, .35);
        overflow: hidden;
        user-select: none;
    }

    .btn::before {
        content: "";
        position: absolute;
        inset: -2px;
        border-radius: 999px;
        opacity: .75;
        filter: blur(10px);
        z-index: 0;
        transform: translateZ(0);
    }

    .btn>span {
        position: relative;
        z-index: 1;
    }

    .btn-primary {
        width: 100%;
        border-color: rgba(107, 225, 227, .35);
    }

    .btn-primary::before {
        background:
            radial-gradient(circle at 20% 50%, rgba(107, 225, 227, .55), transparent 55%),
            radial-gradient(circle at 80% 50%, rgba(107, 225, 227, .30), transparent 60%);
    }

    .btn-primary:hover {
        transform: translateY(-1px) scale(1.01);
        border-color: rgba(198, 201, 215, .36);
        background: rgba(254, 254, 255, .085);
        box-shadow: 0 16px 55px rgba(0, 0, 0, .45);
    }

    .btn-primary:disabled {
        opacity: .5;
        cursor: not-allowed;
    }

    .btn-ghost {
        border-color: rgba(198, 201, 215, .22);
        background: rgba(254, 254, 255, .04);
    }

    .btn-ghost::before {
        background:
            radial-gradient(circle at 20% 50%, rgba(225, 123, 215, .42), transparent 55%),
            radial-gradient(circle at 80% 50%, rgba(225, 123, 215, .22), transparent 60%);
        opacity: .55;
    }

    .btn-ghost:hover {
        background: rgba(254, 254, 255, .07);
        transform: translateY(-1px);
        box-shadow: 0 16px 55px rgba(0, 0, 0, .40);
    }

    .back-link {
        display: block;
        text-align: center;
        margin-top: 1.5rem;
        font-size: .85rem;
        color: rgba(198, 201, 215, .82);
        cursor: pointer;
        transition: color .2s ease;
    }

    .back-link:hover {
        color: var(--c-cyan);
    }

    /* PANEL */
    .page {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    .header {
        position: sticky;
        top: 0;
        z-index: 40;
        background: rgba(0, 0, 0, .30);
        backdrop-filter: blur(14px);
        border-bottom: 1px solid rgba(198, 201, 215, .10);
    }

    .header-inner {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0.9rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
    }

    .brand {
        display: flex;
        align-items: center;
        gap: .75rem;
    }

    .brand-logo {
        width: 45px;
        height: 45px;
        border-radius: 999px;
        background-image: url('./img/comodin.png');
        background-size: cover;
        background-position: center;
        box-shadow: 0 0 0 1px rgba(198, 201, 215, .18), 0 0 40px rgba(107, 225, 227, .18);
        animation: logoPulse 4.5s ease-in-out infinite;
        position: relative;
        overflow: hidden;
    }

    .brand-logo::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 30% 30%, rgba(254, 254, 255, .14), transparent 55%);
        pointer-events: none;
    }

    .brand-text-main {
        font-family: var(--font-title);
        font-size: 1.05rem;
        font-weight: 800;
        letter-spacing: .02em;
    }

    .brand-text-sub {
        font-size: .82rem;
        color: rgba(198, 201, 215, .82);
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: .75rem;
        font-size: .85rem;
        color: rgba(198, 201, 215, .82);
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--c-cyan);
        box-shadow: 0 0 18px rgba(107, 225, 227, .55);
    }

    .main {
        flex: 1;
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1.5rem 2.5rem;
        display: grid;
        grid-template-columns: 3fr 2fr;
        gap: 1.8rem;
    }

    .section-title {
        font-family: var(--font-title);
        font-size: 1.55rem;
        margin-bottom: .35rem;
        letter-spacing: -.01em;
        text-shadow: 0 10px 40px rgba(0, 0, 0, .35);
    }

    .section-subtitle {
        font-size: .92rem;
        color: rgba(198, 201, 215, .86);
        margin-bottom: 1.1rem;
    }

    .panel,
    .form-panel {
        background:
            radial-gradient(900px 600px at 70% 35%, rgba(225, 123, 215, .12), transparent 55%),
            radial-gradient(900px 600px at 45% 60%, rgba(107, 225, 227, .10), transparent 60%),
            linear-gradient(180deg, rgba(254, 254, 255, .06), rgba(26, 24, 29, .72));
        border-radius: var(--radius-lg);
        padding: 1.7rem 1.6rem;
        box-shadow: var(--shadow-soft);
        border: 1px solid rgba(198, 201, 215, .18);
        backdrop-filter: blur(16px);
    }

    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 1rem;
        margin-bottom: 1.0rem;
    }

    .panel-title {
        font-size: 1.05rem;
        font-weight: 800;
        font-family: var(--font-title);
        letter-spacing: -.01em;
    }

    .panel-meta {
        font-size: .8rem;
        color: rgba(198, 201, 215, .82);
    }

    /* ===== NUEVO: barra buscador ===== */
    .toolbar {
        display: flex;
        gap: .75rem;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .search-wrap {
        flex: 1 1 340px;
        display: flex;
        gap: .6rem;
        align-items: center;
        background: rgba(254, 254, 255, .05);
        border: 1px solid rgba(198, 201, 215, .18);
        border-radius: 999px;
        padding: .45rem .6rem;
        backdrop-filter: blur(12px);
    }

    .search-icon {
        width: 34px;
        height: 34px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid rgba(198, 201, 215, .16);
        background: rgba(0, 0, 0, .18);
        flex: 0 0 auto;
    }

    .search-wrap input {
        width: 100%;
        border: none;
        outline: none;
        background: transparent;
        color: var(--c-white);
        font-size: .92rem;
        padding: .35rem .2rem;
    }

    .search-wrap input::placeholder {
        color: rgba(198, 201, 215, .65);
    }

    .btn-clear {
        padding: .55rem .9rem;
        font-size: .82rem;
        white-space: nowrap;
    }

    .table-wrap {
        background: rgba(254, 254, 255, .04);
        border-radius: var(--radius-md);
        overflow: hidden;
        border: 1px solid rgba(198, 201, 215, .16);
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table thead {
        background: rgba(0, 0, 0, .25);
    }

    .data-table th {
        text-align: left;
        padding: .85rem 1rem;
        font-size: .8rem;
        font-weight: 800;
        color: rgba(198, 201, 215, .88);
        border-bottom: 1px solid rgba(198, 201, 215, .16);
        font-family: var(--font-title);
    }

    .data-table tbody tr {
        border-bottom: 1px solid rgba(198, 201, 215, .12);
        transition: background .15s ease;
    }

    .data-table tbody tr:hover {
        background: rgba(254, 254, 255, .05);
    }

    .data-table td {
        padding: .95rem 1rem;
        font-size: .88rem;
        color: var(--c-white);
        vertical-align: top;
    }

    .col-username {
        color: var(--c-cyan);
        font-weight: 700;
    }

    .col-tests {
        display: flex;
        flex-wrap: wrap;
        gap: .4rem;
    }

    .test-badge {
        display: inline-block;
        padding: .3rem .7rem;
        font-size: .75rem;
        border-radius: 999px;
        font-weight: 800;
        color: rgba(254, 254, 255, .92);
        border: 1px solid rgba(198, 201, 215, .18);
        background: rgba(254, 254, 255, .06);
        backdrop-filter: blur(10px);
    }

    .test-badge-1 {
        box-shadow: 0 0 0 1px rgba(228, 199, 106, .18), 0 0 28px rgba(228, 199, 106, .10);
    }

    .test-badge-2 {
        box-shadow: 0 0 0 1px rgba(107, 225, 227, .18), 0 0 28px rgba(107, 225, 227, .10);
    }

    .test-badge-3 {
        box-shadow: 0 0 0 1px rgba(225, 123, 215, .18), 0 0 28px rgba(225, 123, 215, .10);
    }

    .test-badge-4 {
        box-shadow: 0 0 0 1px rgba(164, 168, 192, .20), 0 0 24px rgba(164, 168, 192, .08);
    }

    .test-badge-5 {
        box-shadow: 0 0 0 1px rgba(228, 199, 106, .16), 0 0 24px rgba(225, 123, 215, .08);
    }

    .test-badge-6 {
        box-shadow: 0 0 0 1px rgba(107, 225, 227, .16), 0 0 24px rgba(228, 199, 106, .08);
    }

    .form-title {
        font-family: var(--font-title);
        font-size: 1.3rem;
        font-weight: 800;
        margin-bottom: .5rem;
        letter-spacing: -.01em;
    }

    .form-subtitle {
        font-size: .87rem;
        color: rgba(198, 201, 215, .86);
        margin-bottom: 1.5rem;
        line-height: 1.55;
    }

    .checkbox-group {
        margin-bottom: 1.5rem;
    }

    .checkbox-group label {
        display: block;
        font-size: .9rem;
        font-weight: 700;
        color: rgba(198, 201, 215, .88);
        margin-bottom: .8rem;
    }

    .checkbox-list {
        display: flex;
        flex-direction: column;
        gap: .6rem;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        padding: .7rem 1rem;
        background: rgba(254, 254, 255, .05);
        border: 1px solid rgba(198, 201, 215, .20);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all .2s ease;
        backdrop-filter: blur(12px);
    }

    .checkbox-item:hover {
        background: rgba(254, 254, 255, .07);
        border-color: rgba(107, 225, 227, .45);
    }

    .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        margin-right: .8rem;
        cursor: pointer;
        accent-color: var(--c-cyan);
    }

    .checkbox-item span {
        font-size: .9rem;
        color: var(--c-white);
        font-weight: 600;
    }

    .error-text {
        color: #ff5a6a;
        font-size: .85rem;
        margin-bottom: 1rem;
        min-height: 20px;
    }

    .status-text {
        color: var(--c-cyan);
        font-size: .85rem;
        margin-bottom: 1rem;
        min-height: 20px;
    }

    .btn-full {
        width: 100%;
    }

    .btn-icon {
        font-size: 1.1rem;
    }

    .form-footer {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(198, 201, 215, .14);
        font-size: .8rem;
        color: rgba(198, 201, 215, .82);
        display: flex;
        align-items: center;
        gap: .5rem;
    }

    .dot-soft {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: var(--c-cyan);
        display: inline-block;
        box-shadow: 0 0 14px rgba(107, 225, 227, .45);
    }

    .page-footer {
        background: rgba(0, 0, 0, .20);
        border-top: 1px solid rgba(198, 201, 215, .10);
        padding: 1.5rem;
        text-align: center;
        font-size: .8rem;
        color: rgba(198, 201, 215, .82);
        display: flex;
        flex-direction: column;
        gap: .4rem;
        backdrop-filter: blur(10px);
    }

    #message-box {
        position: fixed;
        top: 0;
        left: 50%;
        transform: translateX(-50%) translateY(-100px);
        width: 100%;
        max-width: 520px;
        padding: 1rem 1.5rem;
        border-radius: 0 0 var(--radius-md) var(--radius-md);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
        z-index: 100;
        transition: opacity .3s ease, transform .3s ease;
        opacity: 0;
        font-size: .9rem;
        font-weight: 700;
        text-align: center;
        border: 1px solid rgba(198, 201, 215, .14);
        backdrop-filter: blur(14px);
    }

    #message-box.show {
        transform: translateX(-50%) translateY(20px);
        opacity: 1;
    }

    #message-box.success {
        background: rgba(107, 225, 227, .22);
        color: var(--c-white);
    }

    #message-box.error {
        background: rgba(255, 90, 106, .18);
        color: var(--c-white);
    }

    #message-box.info {
        background: rgba(225, 123, 215, .18);
        color: var(--c-white);
    }

    /* Acciones + edici√≥n */
    .col-actions {
        white-space: nowrap;
        width: 1%;
    }

    .btn-small {
        padding: .5rem .9rem;
        font-size: .82rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, .28);
    }

    .btn-edit {
        border-color: rgba(225, 123, 215, .35);
        background: rgba(254, 254, 255, .05);
    }

    .btn-edit::before {
        background:
            radial-gradient(circle at 20% 50%, rgba(225, 123, 215, .45), transparent 55%),
            radial-gradient(circle at 80% 50%, rgba(225, 123, 215, .25), transparent 60%);
        opacity: .65;
    }

    .btn-eye {
        margin-left: 0.4rem;
        padding: 0.2rem 0.45rem;
        font-size: 0.8rem;
        line-height: 1;
    }


    .edit-badge {
        display: inline-flex;
        align-items: center;
        gap: .45rem;
        padding: .35rem .75rem;
        border-radius: 999px;
        border: 1px solid rgba(198, 201, 215, .18);
        background: rgba(254, 254, 255, .06);
        color: rgba(198, 201, 215, .95);
        font-size: .78rem;
        font-weight: 800;
        margin-bottom: .9rem;
    }

    .edit-badge strong {
        color: var(--c-cyan);
    }

    .edit-actions {
        display: flex;
        gap: .6rem;
        margin-top: .35rem;
    }

    .btn-eye {
        margin-left: 0.4rem;
        padding: 0.25rem;
        font-size: 0;
        /* ocultamos texto residual si lo hubiera */
        line-height: 1;
        border-radius: 999px;
    }

    .btn-eye .icon-eye {
        width: 16px;
        height: 16px;
        display: block;
    }


    @media (max-width: 900px) {
        .main {
            grid-template-columns: 1fr;
        }
    }
</style>

<body>
    <div class="bg" aria-hidden="true">
        <canvas id="stars"></canvas>
        <div class="hex"></div>
    </div>

    <div id="message-box"></div>

    <!-- LOGIN -->
    <div id="admin-login-view">
        <div class="login-card">
            <div class="login-logo"></div>
            <h1 class="login-title">Panel de Administraci√≥n</h1>
            <p class="login-subtitle">Ingresa tus credenciales para acceder al sistema</p>

            <form id="admin-login-form">
                <div class="field-group">
                    <label for="admin-user">Usuario</label>
                    <input id="admin-user" name="admin-user" type="text" required placeholder="admin">
                </div>
                <div class="field-group">
                    <label for="admin-pass">Contrase√±a</label>
                    <input id="admin-pass" name="admin-pass" type="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div class="error-text" id="login-error"></div>
                <button type="submit" class="btn btn-primary"><span>Ingresar al Panel</span></button>
            </form>

            <span class="back-link" id="back-to-participant">‚Üê Volver a la p√°gina de participantes</span>
        </div>
    </div>

    <!-- PANEL -->
    <div id="admin-panel-view" class="page hidden">
        <header class="header">
            <div class="header-inner">
                <div class="brand">
                    <div class="brand-logo"></div>
                    <div>
                        <div class="brand-text-main">Supermercados Comodin</div>
                        <div class="brand-text-sub">Panel de Administraci√≥n</div>
                    </div>
                </div>

                <div class="header-actions">
                    <div class="status-dot"></div>
                    <span>Admin conectado</span>
                    <button class="btn btn-ghost" id="admin-logout"><span>Cerrar Sesi√≥n</span></button>
                </div>
            </div>
        </header>

        <main class="main">
            <section>
                <h1 class="section-title">Gesti√≥n de Usuarios</h1>
                <p class="section-subtitle">
                    Administra los usuarios participantes y sus tests habilitados.
                </p>

                <div class="panel">
                    <div class="panel-header">
                        <h3 class="panel-title">Usuarios registrados</h3>
                        <span class="panel-meta" id="user-count-text">0 usuarios registrados</span>
                    </div>

                    <!-- NUEVO: toolbar con buscador -->
                    <div class="toolbar">
                        <div class="search-wrap" title="Buscar por usuario, puesto o test">
                            <div class="search-icon">üîé</div>
                            <input id="user-search" type="text" placeholder="Buscar por usuario, puesto o test..."
                                autocomplete="off" />
                        </div>
                        <button class="btn btn-ghost btn-clear" id="clear-search"><span>Limpiar</span></button>
                    </div>

                    <div class="table-wrap">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="col-username">Usuario</th>
                                    <th class="col-password">Contrase√±a</th>
                                    <th class="col-puesto">Puesto</th>
                                    <th class="col-tests">Tests Habilitados</th>
                                    <th class="col-actions">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <aside>
                <div class="form-panel">
                    <h2 class="form-title" id="form-title">Agregar nuevo usuario</h2>
                    <p class="form-subtitle" id="form-subtitle">
                        Completa los datos para crear un nuevo usuario participante y selecciona los tests que tendr√°
                        habilitados.
                    </p>

                    <div id="edit-indicator" class="edit-badge hidden">
                        ‚úèÔ∏è Editando: <strong id="edit-username"></strong>
                    </div>

                    <form id="user-form">
                        <div class="field-group">
                            <label for="userName">Usuario</label>
                            <input id="userName" name="userName" type="text" placeholder="Ej: usuario123" required />
                        </div>

                        <div class="field-group">
                            <label for="userPassword">Contrase√±a</label>
                            <input id="userPassword" name="userPassword" type="password" placeholder="********"
                                required />
                        </div>

                        <div class="field-group">
                            <label for="userPuesto">Puesto</label>
                            <select id="userPuesto" name="userPuesto" required>
                                <option value="" disabled selected>Seleccione un puesto</option>
                                <option value="Ejecutivo/a Comercial">Ejecutivo/a Comercial</option>
                                <option value="Analista Administrativo / Back Office">Analista Administrativo / Back
                                    Office</option>
                                <option value="Supervisor/a o Mando Medio">Supervisor/a o Mando Medio</option>
                                <option value="Representante de Atenci√≥n al Cliente">Representante de Atenci√≥n al
                                    Cliente / Call Center</option>
                            </select>
                        </div>

                        <div class="checkbox-group">
                            <label>Tests Habilitados (selecciona al menos uno)</label>
                            <div class="checkbox-list">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="test" value="1" />
                                    <span>Test 1:</span>
                                </label>

                                <label class="checkbox-item">
                                    <input type="checkbox" name="test" value="2" />
                                    <span>Test 2:</span>
                                </label>

                                <label class="checkbox-item">
                                    <input type="checkbox" name="test" value="3" />
                                    <span>Test 3:</span>
                                </label>

                                <label class="checkbox-item">
                                    <input type="checkbox" name="test" value="4" />
                                    <span>Test 4:</span>
                                </label>
                            </div>
                        </div>

                        <div class="error-text" id="form-error"></div>
                        <div class="status-text" id="form-status"></div>

                        <button type="submit" class="btn btn-primary btn-full" id="submit-button">
                            <span><span class="btn-icon">Ôºã</span> Guardar usuario</span>
                        </button>

                        <div id="edit-actions" class="edit-actions hidden">
                            <button type="button" class="btn btn-ghost btn-full btn-small" id="cancel-edit">
                                <span>Cancelar edici√≥n</span>
                            </button>
                        </div>

                        <div class="form-footer">
                            <span class="dot-soft"></span>
                            <span>La base de datos se esta actualizando.</span>
                        </div>
                    </form>
                </div>
            </aside>
        </main>

        <footer class="page-footer">
            <span>¬© 2026 Escencial Consultora ¬∑ Panel de Administraci√≥n.</span>
            <span>Plataforma automatizada para administraci√≥n de usuarios y evaluaciones.</span>
        </footer>
    </div>

    <script>
        const EYE_ICON = `
<svg class="icon-eye" viewBox="0 0 24 24" aria-hidden="true">
  <ellipse cx="12" cy="12" rx="7" ry="5" fill="none" stroke="currentColor" stroke-width="1.8" />
  <circle cx="12" cy="12" r="2.4" fill="none" stroke="currentColor" stroke-width="1.8" />
</svg>`;

        const EYE_OFF_ICON = `
<svg class="icon-eye" viewBox="0 0 24 24" aria-hidden="true">
  <ellipse cx="12" cy="12" rx="7" ry="5" fill="none" stroke="currentColor" stroke-width="1.8" />
  <circle cx="12" cy="12" r="2.4" fill="none" stroke="currentColor" stroke-width="1.8" />
  <line x1="5" y1="5" x2="19" y2="19" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
</svg>`;

        // ====== Part√≠culas "estrellas" ======
        const canvas = document.getElementById('stars');
        const ctx = canvas.getContext('2d', { alpha: true });

        let W = 0, H = 0, DPR = Math.min(window.devicePixelRatio || 1, 2);
        let stars = [];
        const STAR_COUNT_BASE = 120;

        function resize() {
            W = window.innerWidth;
            H = window.innerHeight;
            DPR = Math.min(window.devicePixelRatio || 1, 2);
            canvas.width = Math.floor(W * DPR);
            canvas.height = Math.floor(H * DPR);
            canvas.style.width = W + 'px';
            canvas.style.height = H + 'px';
            ctx.setTransform(DPR, 0, 0, DPR, 0, 0);

            const count = Math.floor(STAR_COUNT_BASE * (W * H) / (1200 * 700));
            stars = Array.from({ length: Math.max(90, Math.min(220, count)) }, () => ({
                x: Math.random() * W,
                y: Math.random() * H,
                r: Math.random() * 1.35 + 0.25,
                a: Math.random() * 0.6 + 0.15,
                vx: (Math.random() - 0.5) * 0.06,
                vy: (Math.random() - 0.5) * 0.06,
                tw: Math.random() * 0.012 + 0.003
            }));
        }

        function draw() {
            ctx.clearRect(0, 0, W, H);

            const g = ctx.createRadialGradient(W * 0.75, H * 0.35, 0, W * 0.75, H * 0.35, Math.max(W, H) * 0.8);
            g.addColorStop(0, 'rgba(225,123,215,0.10)');
            g.addColorStop(0.35, 'rgba(107,225,227,0.08)');
            g.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = g;
            ctx.fillRect(0, 0, W, H);

            for (const s of stars) {
                s.x += s.vx;
                s.y += s.vy;
                if (s.x < -10) s.x = W + 10;
                if (s.x > W + 10) s.x = -10;
                if (s.y < -10) s.y = H + 10;
                if (s.y > H + 10) s.y = -10;

                s.a += Math.sin((s.x + s.y) * 0.002) * s.tw;
                const alpha = Math.max(0.08, Math.min(0.85, s.a));

                ctx.beginPath();
                ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(254,254,255,${alpha})`;
                ctx.fill();
            }

            requestAnimationFrame(draw);
        }

        resize();
        draw();
        window.addEventListener('resize', resize);

        // ============================================
        // CONFIG
        // ============================================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzsNQg9fdpnWRzfxG3Ha_MBPS7sJwUhKzpj_OuVkkxV4uQeErV7Yd9FMW5TUFtCXI7t/exec';
        const DB_GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby6kBo-HW69iQ6sUx0YbU_xR2qsufgVLOkNCnpPBYeb0A_dn3_u3yR4Q45iK8v9FbdC/exec';

        // ============================================
        // DOM
        // ============================================
        const adminLoginView = document.getElementById('admin-login-view');
        const adminPanelView = document.getElementById('admin-panel-view');
        const adminLoginForm = document.getElementById('admin-login-form');
        const backToParticipantBtn = document.getElementById('back-to-participant');
        const adminLogoutBtn = document.getElementById('admin-logout');
        const userForm = document.getElementById('user-form');
        const userNameInput = document.getElementById('userName');
        const userPasswordInput = document.getElementById('userPassword');
        const userPuestoSelect = document.getElementById('userPuesto');
        const submitButton = document.getElementById('submit-button');
        const formError = document.getElementById('form-error');
        const formStatus = document.getElementById('form-status');
        const userTableBody = document.getElementById('user-table-body');
        const userCountText = document.getElementById('user-count-text');
        const messageBox = document.getElementById('message-box');
        const loginError = document.getElementById('login-error');

        const formTitle = document.getElementById('form-title');
        const formSubtitle = document.getElementById('form-subtitle');
        const editIndicator = document.getElementById('edit-indicator');
        const editUsernameSpan = document.getElementById('edit-username');
        const editActions = document.getElementById('edit-actions');
        const cancelEditBtn = document.getElementById('cancel-edit');

        // BUSCADOR
        const userSearchInput = document.getElementById('user-search');
        const clearSearchBtn = document.getElementById('clear-search');

        // ============================================
        // ESTADO
        // ============================================
        let users = [];
        let filteredUsers = [];
        let isEditMode = false;
        let editingUsername = null;

        // ============================================
        // HELPERS
        // ============================================
        function showView(viewName) {
            adminLoginView.classList.add('hidden');
            adminPanelView.classList.add('hidden');
            if (viewName === 'login') adminLoginView.classList.remove('hidden');
            if (viewName === 'panel') adminPanelView.classList.remove('hidden');
        }

        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = `show ${type}`;
            setTimeout(() => messageBox.classList.remove('show'), 3000);
        }

        function escapeHtml(str) {
            return String(str ?? '').replace(/[&<>"']/g, (m) => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
            }[m]));
        }

        function getSelectedTests() {
            const checkboxes = document.querySelectorAll('input[name="test"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function setSelectedTests(testsArr) {
            const set = new Set((testsArr || []).map(String));
            document.querySelectorAll('input[name="test"]').forEach(cb => {
                cb.checked = set.has(String(cb.value));
            });
        }

        function normalize(s) {
            return String(s ?? '')
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .trim();
        }

        function matchesUser(user, q) {
            const qq = normalize(q);
            if (!qq) return true;

            const uname = normalize(user.userName);
            const puesto = normalize(user.puesto);
            const tests = (user.tests || []).map(t => normalize(t)).join(' ');
            // permite buscar "test 3" o "3"
            const testsLabel = (user.tests || []).map(t => `test ${normalize(t)}`).join(' ');

            return (
                uname.includes(qq) ||
                puesto.includes(qq) ||
                tests.includes(qq) ||
                testsLabel.includes(qq)
            );
        }

        function applySearch() {
            const q = userSearchInput.value;
            filteredUsers = users.filter(u => matchesUser(u, q));
            renderUsers(filteredUsers);
        }

        function enterEditMode(user) {
            isEditMode = true;
            editingUsername = user.userName;

            formTitle.textContent = 'Editar usuario';
            formSubtitle.textContent = 'Modifica contrase√±a, puesto y tests. El usuario (username) no se puede cambiar.';
            editIndicator.classList.remove('hidden');
            editActions.classList.remove('hidden');
            editUsernameSpan.textContent = user.userName;

            userNameInput.value = user.userName;
            userNameInput.disabled = true;

            userPasswordInput.value = user.userPassword || '';
            userPasswordInput.type = 'text';
            userPuestoSelect.value = user.puesto && user.puesto !== '-' ? user.puesto : '';

            setSelectedTests(user.tests || []);

            submitButton.innerHTML = '<span><span class="btn-icon">üíæ</span> Guardar cambios</span>';
            formError.textContent = '';
            formStatus.textContent = '';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function exitEditMode() {
            isEditMode = false;
            editingUsername = null;

            formTitle.textContent = 'Agregar nuevo usuario';
            formSubtitle.textContent = 'Completa los datos para crear un nuevo usuario participante y selecciona los tests que tendr√° habilitados.';
            editIndicator.classList.add('hidden');
            editActions.classList.add('hidden');
            editUsernameSpan.textContent = '';

            userNameInput.disabled = false;
            userForm.reset();
            setSelectedTests([]);

            submitButton.innerHTML = '<span><span class="btn-icon">Ôºã</span> Guardar usuario</span>';
            formError.textContent = '';
            formStatus.textContent = '';
        }

        // ============================================
        // RENDER TABLA (usa lista recibida)
        // ============================================
        function renderUsers(list) {
            const data = Array.isArray(list) ? list : users;
            userTableBody.innerHTML = '';

            if (data.length === 0) {
                userTableBody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: 2rem; color: rgba(198,201,215,.75);">
              ${users.length === 0 ? 'No hay usuarios registrados a√∫n' : 'No se encontraron resultados'}
            </td>
          </tr>
        `;
                // Conteo: si hay b√∫squeda activa, mostramos "X de Y"
                const q = userSearchInput.value.trim();
                if (users.length === 0) userCountText.textContent = '0 usuarios registrados';
                else if (q) userCountText.textContent = `0 resultados de ${users.length}`;
                else userCountText.textContent = `${users.length} usuarios registrados`;
                return;
            }

            data.forEach((user) => {
                const row = document.createElement('tr');

                let testsDisplay = '';
                if (Array.isArray(user.tests) && user.tests.length > 0) {
                    testsDisplay = user.tests.map(testNum => {
                        const n = String(testNum).trim();
                        return `<span class="test-badge test-badge-${escapeHtml(n)}">Test N¬∞${escapeHtml(n)}</span>`;
                    }).join(' ');
                } else {
                    testsDisplay = '<span style="opacity: 0.6">Sin asignar</span>';
                }

                row.innerHTML = `
  <td class="col-username">${escapeHtml(user.userName)}</td>
  <td class="col-password">
    <span class="password-mask">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
    <span class="password-text hidden">${escapeHtml(user.userPassword || '')}</span>
    <button
  type="button"
  class="btn btn-small btn-eye"
  data-action="toggle-password"
  aria-pressed="false"
  title="Ver contrase√±a"
>
  ${EYE_ICON}
</button>

  </td>
  <td style="color: rgba(198,201,215,.8); font-size: 0.9rem;">${escapeHtml(user.puesto || '-')}</td>
  <td class="col-tests">${testsDisplay}</td>
  <td class="col-actions">
    <button class="btn btn-small btn-edit" data-action="edit" data-username="${escapeHtml(user.userName)}">
      <span>Editar</span>
    </button>
  </td>
`;

                userTableBody.appendChild(row);
            });

            // Conteo con b√∫squeda
            const q = userSearchInput.value.trim();
            if (q) {
                userCountText.textContent = `${data.length} resultados de ${users.length}`;
            } else {
                const count = users.length;
                userCountText.textContent = count === 1 ? '1 usuario registrado' : `${count} usuarios registrados`;
            }
        }

        // Delegaci√≥n para editar (busca en users, no en filtered)
        userTableBody.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-action="edit"]');
            if (!btn) return;
            const uname = btn.getAttribute('data-username');
            const user = users.find(u => (u.userName || '').toLowerCase() === (uname || '').toLowerCase());
            if (!user) {
                showMessage('No se pudo cargar el usuario para editar', 'error');
                return;
            }
            enterEditMode(user);
        });
        userTableBody.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-action="toggle-password"]');
            if (!btn) return;

            const row = btn.closest('tr');
            if (!row) return;

            const maskSpan = row.querySelector('.password-mask');
            const textSpan = row.querySelector('.password-text');
            if (!maskSpan || !textSpan) return;

            const isVisible = !textSpan.classList.contains('hidden');

            if (isVisible) {
                // Volver a ocultar
                textSpan.classList.add('hidden');
                maskSpan.classList.remove('hidden');
                btn.innerHTML = EYE_ICON;
                btn.setAttribute('aria-pressed', 'false');
                btn.setAttribute('title', 'Ver contrase√±a');
            } else {
                // Mostrar contrase√±a
                textSpan.classList.remove('hidden');
                maskSpan.classList.add('hidden');
                btn.innerHTML = EYE_OFF_ICON;
                btn.setAttribute('aria-pressed', 'true');
                btn.setAttribute('title', 'Ocultar contrase√±a');
            }
        });



        cancelEditBtn.addEventListener('click', () => {
            exitEditMode();
            showMessage('Edici√≥n cancelada', 'info');
        });

        // BUSCADOR eventos
        userSearchInput.addEventListener('input', applySearch);
        userSearchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                userSearchInput.value = '';
                applySearch();
            }
        });
        clearSearchBtn.addEventListener('click', () => {
            userSearchInput.value = '';
            applySearch();
            userSearchInput.focus();
        });

        // ============================================
        // FETCH LISTAR
        // ============================================
        async function fetchAllUsersFromGoogleScript() {
            try {
                userCountText.textContent = 'Cargando usuarios...';
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?accion=listar`, { method: 'GET' });
                if (!response.ok) throw new Error('Respuesta no OK');

                const data = await response.json();
                if (!data || !Array.isArray(data.usuarios)) {
                    userCountText.textContent = 'Sin datos de usuarios';
                    return [];
                }

                const usuariosCrudos = data.usuarios;
                const cleanedUsers = usuariosCrudos.map((item, index) => {
                    const testsData = item.Test || item.TEST || item.test || item['Tests'] || item['Tests Habilitados'];
                    const userNameData = item.Usuario || item.USUARIO || item.usuario || item.username || item.Username;
                    const userPasswordData =
                        item.Contrase√±a ||
                        item.CONTRASE√ëA ||
                        item.contrase√±a ||
                        item['Contrase√É¬±a'] ||
                        item['Contrasena'] ||
                        item.password;

                    let testsArray = [];
                    if (testsData && typeof testsData === 'string') {
                        testsArray = testsData.split(',').map(t => t.trim()).filter(t => t);
                    } else if (typeof testsData === 'number') {
                        testsArray = [String(testsData)];
                    } else if (Array.isArray(testsData)) {
                        testsArray = testsData.map(String);
                    }

                    return {
                        id: item.id ?? index + 1,
                        userName: userNameData || '',
                        userPassword: userPasswordData || '',
                        puesto: item.Puesto || item.puesto || item.Cargo || '-',
                        tests: testsArray
                    };
                });

                if (data.admin && data.admin.length > 0) {
                    localStorage.setItem('adminData', JSON.stringify(data.admin[0]));
                }

                return cleanedUsers;
            } catch (error) {
                console.error('Error en fetch:', error);
                userCountText.textContent = 'Error al cargar';
                return [];
            }
        }

        // ============================================
        // CREAR (GET)
        // ============================================
        async function sendUserToGoogleScript(userData) {
            const params = new URLSearchParams({
                accion: 'guardar',
                username: userData.username,
                password: userData.password,
                puesto: userData.puesto,
                tests: Array.isArray(userData.tests) ? userData.tests.join(',') : ''
            });

            const url = `${GOOGLE_SCRIPT_URL}?${params.toString()}`;
            const response = await fetch(url, { method: 'GET' });

            if (!response.ok) throw new Error('Error al guardar (red / HTTP)');
            const result = await response.json();

            if (result.estado === 'limite') {
                const error = new Error(result.mensaje || 'Se alcanz√≥ el l√≠mite m√°ximo de usuarios permitidos.');
                error.code = 'LIMITE_USUARIOS';
                throw error;
            }
            if (result.estado !== 'exito') throw new Error(result.mensaje || 'Error al guardar en Google Sheets');

            return true;
        }

        // ============================================
        // ACTUALIZAR (POST text/plain JSON)
        // ============================================
        async function updateUserInGoogleScript(updateData) {
            const payload = {
                accion: 'actualizar',
                username: updateData.username,
                password: updateData.password,
                puesto: updateData.puesto,
                tests: Array.isArray(updateData.tests) ? updateData.tests.join(',') : updateData.tests
            };
            Object.keys(payload).forEach(k => payload[k] === undefined && delete payload[k]);

            const res = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error('Error HTTP al actualizar');
            const text = await res.text();
            let json;
            try { json = JSON.parse(text); } catch { json = { estado: 'error', mensaje: text }; }

            if (!json || json.estado !== 'exito') throw new Error(json?.mensaje || 'No se pudo actualizar el usuario');
            return json;
        }

        // ============================================
        // BD EXTERNA (igual)
        // ============================================
        async function sendUserToBDGoogleScript(userData) {
            const params = new URLSearchParams({
                accion: 'guardar',
                username: userData.username,
                password: userData.password,
                puesto: userData.puesto,
                pack: userData.pack,
                admin: userData.admin,
                tests: Array.isArray(userData.tests) ? userData.tests.join(',') : ''
            });

            const url = `${DB_GOOGLE_SCRIPT_URL}?${params.toString()}`;
            const response = await fetch(url, { method: 'GET' });
            if (!response.ok) throw new Error('Error al guardar la Base de Datos (red / HTTP)');
            const result = await response.json();
            if (result.estado !== 'exito') throw new Error(result.mensaje || 'Error al guardar en la Base de Datos');
            return true;
        }

        // ============================================
        // LOGIN
        // ============================================
        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const user = document.getElementById('admin-user').value.trim();
            const pass = document.getElementById('admin-pass').value.trim();
            loginError.textContent = '';

            try {
                const params = new URLSearchParams({ accion: 'validarAdmin', admin: user, contrasena: pass });
                const url = `${GOOGLE_SCRIPT_URL}?${params.toString()}`;
                const response = await fetch(url, { method: 'GET' });
                if (!response.ok) throw new Error('Error al contactar con el servidor');

                const result = await response.json();
                if (result.estado === 'exito' && result.valido) {
                    showView('panel');
                    showMessage('Bienvenido, Administrador', 'success');
                    adminLoginForm.reset();

                    users = await fetchAllUsersFromGoogleScript();
                    applySearch(); // respeta lo que est√© escrito en el buscador
                } else {
                    loginError.textContent = result.mensaje || 'Credenciales incorrectas.';
                }
            } catch (error) {
                console.error('‚ùå Error en login:', error);
                loginError.textContent = 'Error al conectar con el servidor.';
            }
        });

        backToParticipantBtn.addEventListener('click', () => window.location.href = 'index.html');
        adminLogoutBtn.addEventListener('click', () => {
            showView('login');
            showMessage('Sesi√≥n cerrada', 'info');
            exitEditMode();
            userSearchInput.value = '';
        });

        // ============================================
        // FORM (CREAR o EDITAR)
        // ============================================
        userForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            formError.textContent = '';
            formStatus.textContent = '';

            const userNameValue = userNameInput.value.trim();
            const userPasswordValue = userPasswordInput.value.trim();
            const userPuestoValue = userPuestoSelect.value.trim();
            const selectedTests = getSelectedTests();

            if (!userNameValue || !userPuestoValue) {
                formError.textContent = 'Por favor completa Usuario y Puesto.';
                return;
            }
            if (selectedTests.length === 0) {
                formError.textContent = 'Debes seleccionar al menos un test habilitado.';
                return;
            }

            // EDITAR
            if (isEditMode) {
                const updatePayload = {
                    username: editingUsername,
                    puesto: userPuestoValue,
                    tests: selectedTests
                };
                if (userPasswordValue) updatePayload.password = userPasswordValue;

                submitButton.disabled = true;
                submitButton.textContent = 'Guardando...';
                formStatus.textContent = 'Actualizando usuario en Google Sheets...';

                try {
                    await updateUserInGoogleScript(updatePayload);

                    users = await fetchAllUsersFromGoogleScript();
                    applySearch();

                    showMessage('Usuario actualizado correctamente', 'success');
                    exitEditMode();
                } catch (err) {
                    console.error('Error actualizando:', err);
                    showMessage(err.message || 'Error al actualizar usuario', 'error');
                    formStatus.textContent = 'Error al actualizar.';
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<span><span class="btn-icon">üíæ</span> Guardar cambios</span>';
                } finally {
                    submitButton.disabled = false;
                }
                return;
            }

            // CREAR
            if (!userPasswordValue) {
                formError.textContent = 'Por favor completa Contrase√±a.';
                return;
            }

            const userExists = users.some(u => (u.userName || '').toLowerCase() === userNameValue.toLowerCase());
            if (userExists) {
                formError.textContent = 'Ya existe un usuario con ese nombre de usuario.';
                return;
            }

            const newUser = {
                username: userNameValue,
                password: userPasswordValue,
                puesto: userPuestoValue,
                tests: selectedTests
            };

            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';
            formStatus.textContent = 'Guardando usuario en Google Sheets...';

            try {
                await sendUserToGoogleScript(newUser);
            } catch (error) {
                console.error('Error en sendUserToGoogleScript:', error);

                if (error.code === 'LIMITE_USUARIOS' || (typeof error.message === 'string' && error.message.toLowerCase().includes('l√≠mite de usuarios'))) {
                    showMessage(error.message || 'Se alcanz√≥ el l√≠mite m√°ximo de usuarios permitidos.', 'error');
                    formStatus.textContent = 'Se alcanz√≥ el l√≠mite m√°ximo de usuarios permitidos.';
                } else {
                    showMessage('Error al registrar usuario en Google Sheets', 'error');
                    formStatus.textContent = 'Error al guardar en Google Sheets.';
                }

                submitButton.disabled = false;
                submitButton.innerHTML = '<span><span class="btn-icon">Ôºã</span> Guardar usuario</span>';
                return;
            }

            try {
                const adminData = localStorage.getItem('adminData');
                let admin = { nombre: 'Desconocido' };
                if (adminData) admin = JSON.parse(adminData);

                const userWithExtras = { ...newUser, pack: 2, admin: admin.nombre };
                await sendUserToBDGoogleScript(userWithExtras);

                showMessage('Usuario registrado exitosamente', 'success');

                users = await fetchAllUsersFromGoogleScript();
                userForm.reset();
                setSelectedTests([]);
                formStatus.textContent = '';

                // Mantener b√∫squeda aplicada
                applySearch();
            } catch (error) {
                console.error('Error en sendUserToBDGoogleScript:', error);
                showMessage('Error al registrar usuario en la Base de Datos', 'error');
                formStatus.textContent = 'Error al guardar en la Base de Datos.';
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = '<span><span class="btn-icon">Ôºã</span> Guardar usuario</span>';
            }
        });

        // INIT
        showView('login');
    </script>
</body>

</html>